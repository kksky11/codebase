/*
 * configuration
 *      "accountsUrl"       : "url of accounts site",
        "clientId"          : "To be given by sso admin",
        "redirectLoginUri"  : "URL to redirect after login",
        "redirectLogoutUri" : "URL to redirect after logout",
        "scope"             : "Scope to access services for",
        "siteId"            : "To be given by sso admin",
        "encryptionKey"     : "To be given by sso admin"
 */

const utility           = require('./utility');
const accountService    = require('./service/accountService');

function PaisabazaarReactSso (configuration, additionalData) {
    this.configuration              = configuration;
    this.additionalData             = additionalData || {};
    this.tokenSource                = this.configuration.tokenSource || 'cookie';

    this.setEnvironment             = function (configuration) {
        this._environment   = configuration.environment || 'development';
    };

    this.setSsoCookieName           = function () {
        var cookieNameObj   = {
            development : 'PB_GLSS_TOKEN_DEV',
            staging     : 'PB_GLSS_TOKEN_DEV',
            local       : 'PB_GLSS_TOKEN_DEV',
            production  : 'PB_GLSS_TOKEN'
        };

        this._ssoCookieName     = cookieNameObj[this._environment] || cookieNameObj.development;
    };

    this.getCookieValue             = function (name) {
        switch (this.tokenSource) {
            case 'cookie' :
                return utility.getCookie(name) || '';

            case 'custom' :
                return this.additionalData[name]  || '';
                
            default :
                return '';
        }
    };

    this.searchAuthorizationMethod  = function (data) {
        var cookieData      = this.getCookieValue(this._ssoCookieName);
        var urlParams       = utility.urlParams();

        if (false === utility.isEmpty(data.username) && false === utility.isEmpty(data.password)) {
            return { authType : 'user_credential', username : data.username, password : data.password};
        }

        if (false === utility.isEmpty(data.mobileNo) && false === utility.isEmpty(data.otp)) {
            return { authType : 'otp', otp : data.otp};
        }

        if (false === utility.isEmpty(data.mobileNo) && false === utility.isEmpty(data.password)) {
            return { authType : 'mobile_credential', password : data.password};
        }
        
        if (false === utility.isEmpty(urlParams.glssKey) && false === utility.isEmpty(urlParams.siteId)) {
            return { authType : 'glss_key', glssKey : urlParams.glssKey, siteId : urlParams.siteId };
        }

        if (false === utility.isEmpty(cookieData)) {
            return { authType : 'glss_token', glssToken : cookieData};
        }

        return {};
    };

    /*
        * createLoginLink
        * @description This function is used to create a login link of paisabazaar accounts
        * @param {guid} state
        * @param {string} authType authentication method to display
        * @param {object} options  screenType, additionalData
        * @returns {string} Redirection link to Paisabazaar Accounts
        */
    this.createLoginLink            = function (state, authType, options) {
        var requiredParams      = ['redirectLoginUri', 'scope', 'clientId', 'accountsUrl'];
        if (options.journeyType && 'JOURNEY_OTP' === options.journeyType) requiredParams.push('mobileNo');

        var hasRequiredParams   = utility.hasRequiredParams(requiredParams, utility.extend(options.additionalData, this.configuration));
        var _this               = this;

        if (false === utility.isEmpty(hasRequiredParams)) { return Promise.reject(new Error('[' + hasRequiredParams.join(',') + '] is required')); }

        authType            = authType || 'otp';
        options             = options || {};

        var urlData         = utility.extend({
            client_id       : this.configuration.clientId, 
            redirect_uri    : this.configuration.redirectLoginUri,
            state           : state,
            scope           : this.configuration.scope,
            auth_type       : authType,
            screen_type     : options.screenType || '0',
            journey_type    : options.journeyType || 'REDIRECT',
            version         : options.version || '1'
        }, options.additionalData || {});

        var loginLink   =  utility.serializeUrl(urlData, this.configuration.accountsUrl + '/authorize');

        switch (urlData.journey_type) {
            case "JOURNEY"      :
            case "JOURNEY_OTP"  :
                return _this.createWidget(loginLink, urlData.journey_type, function (error, data) {
                    if (options.dataCallback) return options.dataCallback(error, data);
                });
                
            default :
                return loginLink;
        }
    }

    /*
        * createLogoutLink
        * @description This function is used to create a logout link of paisabazaar accounts
        * @returns {string} Redirection link to Paisabazaar Product
        */
    this.createLogoutLink           = function () {
        var hasRequiredParams = utility.hasRequiredParams([
            'redirectLogoutUri',
            'accountsUrl'
        ], this.configuration);

        if (false === utility.isEmpty(hasRequiredParams)) { return Promise.reject(new Error('[' + hasRequiredParams.join(',') + '] is required')); }

        return utility.serializeUrl({
            redirect_uri    : this.configuration.redirectLogoutUri
        }, this.configuration.accountsUrl + '/logout');
    }
    
    /*
        * sessionExists
        * @description This function is used to create a logout link of paisabazaar accounts
        * @returns {string} Redirection link to Paisabazaar Product
        */

    this.sessionExists              = function () {
        return false === utility.isEmpty(this.getCookieValue(this._ssoCookieName)) || 
            false === utility.isEmpty(utility.urlParams('glssKey'));
    }    

    /*
        * getAuthorizationCode
        * @description This function is used to get authorization code
        * @returns {Promise} Authorization code data
        */
    this.getAuthorizationCode       = function (state, data) {
        var hasRequiredParams = utility.hasRequiredParams([
            'redirectLoginUri', 
            'scope', 
            'clientId',
            'accountsUrl'
        ], utility.extend(this.configuration, data));

        if (false === utility.isEmpty(hasRequiredParams)) { 
            return Promise.reject(new Error('[' + hasRequiredParams.join(',') + '] is required'));
        }

        data = data || {};
        var authData = this.searchAuthorizationMethod(data);

        return accountService.getAuthorizeData(
            this.configuration.accountsUrl,
            {
                tokenSource	        : this.tokenSource,
                response_type	    : "code",
                client_id           : this.configuration.clientId,
                redirect_uri	    : this.configuration.redirectLoginUri,
                state               : state,
                scope               : utility.isEmpty(data.scope) ? this.configuration.scope : data.scope,
                auth_type           : utility.isEmpty(authData) ? 'otp' : authData.authType,
                mobileNo            : data.mobileNo,
                visitorId           : data.visitorId,
                otp                 : data.otp,
                siteId		        : authData.siteId || this.configuration.siteId,
                glss_token          : authData.glssToken,
                glss_key            : authData.glssKey,
                username            : false === utility.isEmpty(authData.username) && (authData.username.length <= 20  ? this.encrypt(authData.username) : authData.username) || null,
                password            : false === utility.isEmpty(authData.password) && (authData.password.length <= 20  ? this.encrypt(authData.password) : authData.password) || null,
                enableWhatsappAlert : data.enableWhatsappAlert || false
            }
        );
    }

    /*
        * logout via API
        * @description This function is used to logot of system if logout flow is API
        * @returns {Promise} Success / Fail
        */
    this.logout                     = function () {
        var hasRequiredParams = utility.hasRequiredParams([
            'redirectLogoutUri',
            'accountsUrl'
        ], utility.extend(this.configuration));

        if (false === utility.isEmpty(hasRequiredParams)) { 
            return Promise.reject(new Error('[' + hasRequiredParams.join(',') + '] is required'));
        }

        return accountService.logout(
            this.configuration.accountsUrl,
            this.getCookieValue(this._ssoCookieName),
            {
                redirect_uri	: this.configuration.redirectLogoutUri,
                tokenSource     : this.tokenSource
            }
        );
    };

    /*
        * logout via API
        * @description This function is used to logot of system if logout flow is API
        * @returns {Promise} Success / Fail
        */
    this.sendOtp                    = function (data) {
        var hasRequiredParams = utility.hasRequiredParams([
            'mobileNo',
            'accountsUrl'
        ], utility.extend(this.configuration, data));

        if (false === utility.isEmpty(hasRequiredParams)) { 
            return Promise.reject(new Error('[' + hasRequiredParams.join(',') + '] is required'));
        }

        return accountService.sendOtp(
            this.configuration.accountsUrl,
            this.configuration.siteId,
            this.configuration.encryptionKey,
            {
                mobileNo        : data.mobileNo,
                visitorId       : data.visitorId,
                visitId         : data.visitId,
                productId       : data.productId || null,
                event           : data.event || null,
                eventPayload    : data.eventPayload || {}
            }
        );
    };

    this.checkPreference                    = function (data) {
        var hasRequiredParams = utility.hasRequiredParams([
            'mobileNo',
            'accountsUrl',            
        ], utility.extend(this.configuration, data));

        if (false === utility.isEmpty(hasRequiredParams)) { 
            return Promise.reject(new Error('[' + hasRequiredParams.join(',') + '] is required'));
        }

        return accountService.checkPreference(
            this.configuration.accountsUrl,
            this.configuration.siteId,
            {
                mobileNo        : data.mobileNo
            }
        );
    };

    this.otpAutoRead                        = function () {
        return new Promise(function(resolve, reject) {
            if (window && navigator && 'OTPCredential' in window) {
                var signal    = new AbortController();
                setTimeout(function() {
                    signal && signal.abort();
                }, 1 * 60 * 1000);
    
                return navigator.credentials
                    .get({
                        abort   : signal, 
                        otp     : { transport: ['sms']}
                    })
                    .then(function(content) {
                        signal && signal.abort();
                        return resolve(content && content.code ? content.code : false);
                    })
                    .catch(function(e) {
                        signal && signal.abort();
                        return resolve(false)
                    });
            }
    
            return resolve(false);
        })
    };

    this.encrypt        = function (plainText) {
        return accountService.encrypt(plainText, this.configuration.encryptionKey);
    }

    this.createWidget   = function (loginLink, journeyType, callback) {
        var wrapperElement      = document.createElement("div");
        wrapperElement.setAttribute("id", "sso-sign-in-widget");

        var closeWidget         = function () {
            document.body.style.overflow    = null;
            wrapperElement && wrapperElement.parentNode && wrapperElement.parentNode.removeChild(wrapperElement);
            window.removeEventListener('message', onPostMessageSuccess);
        }

        var modalElement            = document.createElement("div");
        modalElement.setAttribute("class", "widget_modal");
        modalElement.onclick        = closeWidget;

        var modalIframeWrapper      = document.createElement("div");
        modalIframeWrapper.setAttribute("class", 'JOURNEY_OTP' === journeyType ? "modal_iframe_otp" : "modal_iframe");             

        modalIframeWrapperImage     = document.createElement("img");
        modalIframeWrapperImage.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAACHUExURQBr/1qd/+/3/0mV/8bf/xt8/9fn/////wBj/wJr/4W2/9/v/0CN/53G//f3/42+/422/+fv/ySF/2um/6bG/2Om/y2F/5W+/yR8/zeN/67P/wd0/wdr/3Su/7bX/0CV//f//8/f/3yu/6bP/1Gd/xJ8/77X/5XG/1GV/zeF/2uu/xJ0/+f3/7cSJ1oAAAPlSURBVFjDpVcHYtswDDzZkkgPOd6xs2eTjv+/ryDAAUhOa7dqY0kUeThMgnD5GnXV+nby92tdbUc8n3/g4nNbwcN7/pErv0Newlu6VW0Siwi10XPzf7mn8fgmD5tFASDxTVkmwtUbsvyEwbdGSCCIr++UwKhEZpMUSmwKq+cE0N5OkOQqMYoL9Lry1EYVGrMMKGKzzoB+41+6NU8MsLHsAa17FpuXKQZ+EwBaKLcV81sNzDKjBFwFPaosl6go90E/hPGKAGDjJqoM5X/fQ9BsnrA11LWhlLie9RVGh0ppnKIk+iEJPEEiI1RYKwaFA2BjGDoeCyCwBwURbLBBp4TmZsyU56joNumQ164P9M/k0QnDGn4mjvwVZ93cY+BKQ0LFqMolGTlmgKH85C8b+L5nxZlz42E8qlgtJGysptHnosIpGxRHK5+Z2lIzgy+EA1btHE0oUATw6HHaDWU9bMGCckWdbdDPqqG6DV808jld7lIZqNkGGN+/VHcnKACllL1xnZyy5+iqhB8zGK+4/u8GqZ0VE4/uyWfTsWs/OnqgdWEsMNi42fY1YOwGdtC7CaF0zm3dW3j/5txqEm2w/PUZ5ryGKtpjkDasGFO4ojlHiYYFy2MGYeMIkojD9SAtbYoteQqP3Dj3kL0gYy/EyqYAzP5Hf9NgRPmyC4Tpzl6Qz/u0C+g66NW+5UEMlnHoGMUJAymVTmJCbVgqKyV9iUEca4K4nzkOeHAkzlUcVAAzhWsGkDkEcMg2EIIrsQdU8YDdRojBMtJ5DwxEhbnkBTCLAF5vhNqIzMAXFSY+28BHBnPdBOhuQq6r5AWP787NAkHOxjhZvJAVTjZQFXgavCDfyI1bZAZ8HQhT52EyDVJV9mAvCOqrFBLU2XW4D/xgGJQqKA8EcBPj+iloIKH8EqeSDSe6DVLJHBcFgEVLRve3MwlAVmH1sA+TKLjvlXRJpl5NIYAt5eHDwyJNDgDrmWtvaDnliamYpazn7aULWv4IxeD5Mc6oXc22Cc2kaXlKD6cCqZNAej+oUiNzjvtBE5fiUCcWM7AtntkwdR9ZbKk+fXAcQNnZroAJQXjjh/AeGVhLQwmyG7h1Y1h1HUMFZZdL1dsP2nA/DAM2YoG27XdxV05hpKVZtcPjvPHaNV71LQapdHI9CKNlv/8ZNp3N+cJOyVrbNu9ygKo0mv8G0GF0lrpfShnFZvscjFMgodlu/0eHNh84zqTQm0ZHt3jkuUyLRLdZuEUAaO8uoKAB0qFLjn2X26HO50Y5eF6IIAfPeHaW1uciiHz0HUWENh2+zgKRw/con53luav2+fj/B7/sw/F/kRb9BtxjY7kv3/qqAAAAAElFTkSuQmCC';

        modalIframeCloseLabel           = document.createElement("label");
        modalIframeCloseLabel.setAttribute('class', 'close');
        modalIframeCloseLabel.onclick   = closeWidget;

        var modalIframe             = document.createElement("iframe");
        modalIframe.src             = loginLink;
        modalIframe.setAttribute('allow', 'otp-credentials');
        modalIframeWrapper.appendChild(modalIframeCloseLabel);
        modalIframeWrapper.appendChild(modalIframeWrapperImage);
        modalIframeWrapper.appendChild(modalIframe);

        var onPostMessageSuccess    = function (e) {
            try {
                var data                = JSON.parse(e.data);

                switch (data.event) {
                    case 'auth' :
                        closeWidget();
                        return callback(null, data.data);

                    case 'closed_by_user' :
                        closeWidget();
                        return callback({ error : data.event });

        
                    case 'boxSize' :
                        if ('JOURNEY_OTP' !== journeyType) return false;
                        if ('large' === data.data || 'medium' === data.data || 'small' === data.data || 'xl' === data.data) {
                                modalIframeWrapper.classList.remove("otp_large", 'otp_medium', 'otp_small','otp_xl');
                                modalIframeWrapper.classList.add("otp_" + data.data);
                        }
                        
                        return false;
                }
            } catch(error) {
                return false;
            }
        }

        var innerHTML               = '\
            <style> \
                #sso-sign-in-widget .widget_modal                 { background:#032143; position:fixed; bottom:0; left:0; right:0; top:0; opacity:0.63; z-index:999; } \
                #sso-sign-in-widget .modal_iframe                 { top:0; bottom:0; left:0; right:0; margin:auto; position:fixed; z-index:999; background:#fff; width: 80%; height:545px; border-radius:18px; display:flex; justify-content:center; align-items:center; } \
                #sso-sign-in-widget .modal_iframe_otp             { top:0; bottom:0; left:0; right:0; margin:auto; position:fixed; z-index:999; background:#fff; width: 30%; height:350px; border-radius:18px; display:flex; justify-content:center; align-items:center; } \
                #sso-sign-in-widget .otp_xl                       { height:580px; } \
                #sso-sign-in-widget .otp_large                    { height:530px; } \
                #sso-sign-in-widget .otp_medium                   { height:465px; } \
                #sso-sign-in-widget .otp_small                    { height:410px; } \
                #sso-sign-in-widget .modal_iframe .close:hover, #sso-sign-in-widget .modal_iframe_otp .close:hover {border-radius:50%; z-index:999; cursor:pointer;background-color:#aab7c636;} \
                #sso-sign-in-widget .modal_iframe .close, #sso-sign-in-widget .modal_iframe_otp .close { position:absolute; top:5px; right:5px; background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKBAMAAAB/HNKOAAAAGFBMVEUAAAADIkQDIUMCIkQCIUICIEMDIUP///+E2VB0AAAAB3RSTlMAYmNp09T8VnTEWAAAAAFiS0dEBxZhiOsAAAAtSURBVAjXYwhiYGBQYVBTYGBKYmBMZhAzYGAQM0wGCjKlKcBJsAhEFqISrAsAslgF+e+wE90AAAAASUVORK5CYII=") no-repeat center center; display:inline-block; padding:20px; } \
                #sso-sign-in-widget .modal_iframe iframe, #sso-sign-in-widget .modal_iframe_otp iframe  { width:100%; height:100%; border:none;border-radius:18px; position:absolute; left:0; top:0 } \
                @media only screen and (max-width:640px) { \
                    #sso-sign-in-widget .modal_iframe                 { width:100%; height:100%; position:fixed; top:0; bottom:0px; border-radius:0; } \
                    #sso-sign-in-widget .modal_iframe_otp             { width:100%; position:fixed; bottom:-4px; top:inherit; } \
                    #sso-sign-in-widget .modal_iframe iframe        { width:100%; height:100%; border-radius:0; position:absolute; left:0; top:0 } \
                    #sso-sign-in-widget .modal_iframe_otp iframe    { width:100%; border-radius:18px 18px 0 0; } \
                } \
            </style>';

        wrapperElement.innerHTML        = innerHTML;
        wrapperElement.appendChild(modalElement);
        wrapperElement.appendChild(modalIframeWrapper);

        //Event Listner to read data 
        window.addEventListener('message', onPostMessageSuccess);

        document.body.style.overflow    = "hidden";
        document.body.appendChild(wrapperElement);
    }

    this.environment    = this.setEnvironment(configuration);
    this.ssoCookieName  = this.setSsoCookieName();
}

if (typeof exports !== 'undefined') {
    if (typeof module !== 'undefined' && module.exports) { exports = module.exports = PaisabazaarReactSso; }
    exports.PaisabazaarReactSso  = PaisabazaarReactSso;
}

if (typeof window !== 'undefined') window.PaisabazaarReactSso             = PaisabazaarReactSso;